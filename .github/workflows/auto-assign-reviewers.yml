name: Auto Comment and Mention Reviewers Based on Labels

on:
  pull_request:
    types:
      - labeled
      - synchronize
      - opened

jobs:
  auto-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get PR labels
        id: pr_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # èŽ·å– PR æ ‡ç­¾å¹¶ç¡®ä¿æ­£ç¡®æ ¼å¼
          LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels | jq -r '.[].name' | tr '\n' ' ')
          echo "Labels: $LABELS"
          echo "LABELS=$LABELS" >> $GITHUB_ENV

      - name: Prepare reviewer mappings
        id: reviewer-mappings
        run: |
          # å®šä¹‰æ ‡ç­¾å’Œå®¡æ ¸è€…çš„æ˜ å°„
          LABELS_TO_REVIEWERS='{
            "frontend": "@kurisaW, @Nedki-L, @KurisaW-Collaborative",
            "backend": "@kurisaW, @Nedki-L",
            "design": "@kurisaW",
            "action": "@kurisaW, @PeterJhon"
          }'

          # èŽ·å–PRæ ‡ç­¾å¹¶ç¡®å®šéœ€è¦çš„å®¡æ ¸è€…
          REQUIRED_REVIEWERS=""
          for label in $(echo "${{ env.LABELS }}" | tr " " "\n"); do
            REVIEWERS=$(echo $LABELS_TO_REVIEWERS | jq -r --arg label "$label" '.[$label] // empty')
            REQUIRED_REVIEWERS="${REQUIRED_REVIEWERS} ${REVIEWERS}"
          done

          # æ ¼å¼åŒ–å®¡æ ¸è€…åˆ—è¡¨ï¼ŒåŽ»é™¤å¤šä½™çš„ç©ºæ ¼å’Œæ¢è¡Œï¼Œå¹¶åˆ é™¤ä¸å¿…è¦çš„å­—ç¬¦
          # åŽ»é‡å¹¶åŽ»æŽ‰å¤šä½™çš„ç©ºæ ¼å’Œé€—å·
          REVIEWERS_LIST=$(echo "$REQUIRED_REVIEWERS" | tr -s '[:space:]' ' ' | sed 's/^ //;s/ $//' | tr ',' '\n' | sort -u | tr '\n' ',' | sed 's/,$//')
          # æœ€åŽåŽ»é™¤é¢å¤–çš„ç©ºæ ¼æˆ–é€—å·
          REVIEWERS_LIST=$(echo "$REVIEWERS_LIST" | tr -s ' ' | sed 's/,$//')
          echo "REVIEWERS_LIST=$REVIEWERS_LIST" >> $GITHUB_ENV

      - name: Add comment and mention reviewers
        run: |
          REVIEWERS="${{ env.REVIEWERS_LIST }}"
          if [ -z "$REVIEWERS" ]; then
            echo "No reviewers to mention."
          else
            # æž„å»ºè¯„è®ºå†…å®¹
            COMMENT_BODY=$(jq -n --arg reviewers "$REVIEWERS" --arg labels "${{ env.LABELS }}" \
              '{"body": "Hey \($reviewers), could you please review this PR? ðŸ˜Š\n\nThe following labels were applied:\n- \($labels)\n\nPlease check the changes carefully, and let us know if you need any further details. Thank you for your time!"}')
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "$COMMENT_BODY" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments
          fi
