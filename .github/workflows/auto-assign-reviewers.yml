name: Auto Comment and Mention Reviewers Based on Labels

on:
  pull_request:
    types:
      - labeled
      - synchronize
      - opened

jobs:
  auto-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get PR labels
        id: pr_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å– PR æ ‡ç­¾
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name')
          echo "Labels: $LABELS"
          echo "::set-output name=labels::$LABELS"

      - name: Prepare reviewer mappings
        id: reviewer-mappings
        run: |
          # å®šä¹‰æ ‡ç­¾å’Œå®¡æ ¸è€…çš„æ˜ å°„
          LABELS_TO_REVIEWERS=$(echo '{
            "frontend": ["kurisaW", "Nedki-L", "PeterJhon"],
            "backend": ["kurisaW", "Nedki-L"],
            "design": ["kurisaW"]
          }')

          # æ£€æŸ¥ PR æ ‡ç­¾ï¼Œç¡®å®šéœ€è¦@çš„å®¡æ ¸è€…
          REQUIRED_REVIEWERS=$(for label in $(echo "${{ steps.pr_labels.outputs.labels }}" | tr " " "\n"); do
            echo $LABELS_TO_REVIEWERS | jq -r --arg label "$label" '.[$label] // empty'
          done | sort | uniq)

          # æ ¼å¼åŒ–å®¡æ ¸è€…åˆ—è¡¨ï¼Œç¡®ä¿æ¯ä¸ªå®¡æ ¸è€…åå‰æœ‰ '@'ï¼Œå¹¶ä¸”å®¡æ ¸è€…ä¹‹é—´ç”¨é€—å·å’Œç©ºæ ¼åˆ†éš”
          REVIEWERS_LIST=$(echo "$REQUIRED_REVIEWERS" | tr '\n' ' ' | sed 's/^\s*//;s/\s*$//' | tr ' ' ', ' | sed 's/, $//')

          # å¤„ç†å•ä¸ªå®¡æ ¸è€…æƒ…å†µï¼Œç¡®ä¿æ²¡æœ‰å¤šä½™çš„é€—å·æˆ–ç©ºæ ¼
          REVIEWERS_LIST="@$(echo $REVIEWERS_LIST | sed 's/ /, @/g')"

          echo "Required reviewers: $REVIEWERS_LIST"
          echo "::set-output name=reviewers::${REVIEWERS_LIST}"

      - name: Add comment and mention reviewers
        run: |
          REVIEWERS="${{ steps.reviewer-mappings.outputs.reviewers }}"
          if [ -z "$REVIEWERS" ]; then
            echo "No reviewers to mention."
          else
            # æ„å»ºè¯„è®ºå†…å®¹
            COMMENT_BODY="Hey $REVIEWERS, could you please review this PR? ğŸ˜Š\n\nThe following labels were applied:\n- ${{ steps.pr_labels.outputs.labels }}\n\nPlease check the changes carefully, and let us know if you need any further details. Thank you for your time!"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"$COMMENT_BODY\"}" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments
          fi
