name: Auto Comment and Mention Reviewers Based on Labels

on:
  pull_request:
    types:
      - labeled
      - synchronize
      - opened

jobs:
  auto-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get PR labels
        id: pr_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取 PR 标签
          LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels --jq '.labels[].name')
          echo "Labels: $LABELS"
          echo "::set-output name=labels::$LABELS"

      - name: Prepare reviewer mappings
        id: reviewer-mappings
        run: |
          # 定义标签和审核者的映射
          LABELS_TO_REVIEWERS=$(echo '{
            "frontend": ["kurisaW", "Nedki-L", "PeterJhon"],
            "backend": ["kurisaW", "Nedki-L"],
            "design": ["kurisaW"]
          }')

          # 获取PR标签并确定需要的审核者
          REQUIRED_REVIEWERS=$(for label in $(echo "${{ steps.pr_labels.outputs.labels }}" | tr " " "\n"); do
            echo $LABELS_TO_REVIEWERS | jq -r --arg label "$label" '.[$label] // empty'
          done | sort | uniq)

          # 初始化空的审核者列表
          REVIEWERS_LIST=""

          # 遍历每个审核者，并为每个审核者前加上 '@'
          for reviewer in $REQUIRED_REVIEWERS; do
            REVIEWERS_LIST="$REVIEWERS_LIST@${reviewer}, "
          done

          # 删除最后一个逗号和空格
          REVIEWERS_LIST=$(echo "$REVIEWERS_LIST" | sed 's/, $//')

          echo "Required reviewers: $REVIEWERS_LIST"
          echo "::set-output name=reviewers::${REVIEWERS_LIST}"

      - name: Add comment and mention reviewers
        run: |
          REVIEWERS="${{ steps.reviewer-mappings.outputs.reviewers }}"
          if [ -z "$REVIEWERS" ]; then
            echo "No reviewers to mention."
          else
            # 构建评论内容
            COMMENT_BODY="Hey $REVIEWERS, could you please review this PR? 😊\n\nThe following labels were applied:\n- ${{ steps.pr_labels.outputs.labels }}\n\nPlease check the changes carefully, and let us know if you need any further details. Thank you for your time!"
            curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "{\"body\": \"$COMMENT_BODY\"}" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments
          fi
