name: Auto Comment and Mention Reviewers Based on Labels

on:
  pull_request:
    types:
      - labeled
      - synchronize
      - opened

jobs:
  auto-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v2

      - name: Get PR labels
        id: pr_labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å– PR æ ‡ç­¾
          LABELS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels | jq -r '.[].name' | tr '\n' ' ')
          echo "Labels: $LABELS"
          echo "LABELS=$LABELS" >> $GITHUB_ENV

      - name: Load label-reviewers mapping from JSON file
        id: load-mapping
        run: |
          # è¯»å–ä»“åº“ä¸­çš„æ ‡ç­¾ä¸å®¡æ ¸è€…æ˜ å°„æ–‡ä»¶
          MAPPING_FILE=".github/workflows/label-reviewers.json"
  
          if [ ! -f "$MAPPING_FILE" ]; then
            echo "Mapping file not found!"
            exit 1
          fi
  
          # ä½¿ç”¨ jq ç›´æ¥ä» JSON æ–‡ä»¶ä¸­è¯»å–å¹¶è·å–æ•°æ®
          LABELS_TO_REVIEWERS=$(cat $MAPPING_FILE)

          # è¾“å‡ºåˆ°æ–‡ä»¶ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "$LABELS_TO_REVIEWERS" > labels_to_reviewers.json

      - name: Prepare reviewer mappings
        id: reviewer-mappings
        run: |
          # è·å– PR æ ‡ç­¾å¹¶ç¡®å®šéœ€è¦çš„å®¡æ ¸è€…
          REQUIRED_REVIEWERS=()

          # éå† PR æ ‡ç­¾ï¼Œå¹¶ä¸ºæ¯ä¸ªæ ‡ç­¾æ·»åŠ ç›¸åº”çš„å®¡æ ¸è€…
          for label in $(echo "${{ env.LABELS }}" | tr " " "\n"); do
            # ä½¿ç”¨ jq ä» JSON æ–‡ä»¶ä¸­è·å–å®¡æ ¸è€…
            REVIEWERS=$(jq -r --arg label "$label" '.[$label] // empty' labels_to_reviewers.json)

            # æ£€æŸ¥å®¡æ ¸è€…æ˜¯å¦ä¸ºç©º
            if [ -n "$REVIEWERS" ]; then
              # å°†å®¡æ ¸è€…æ·»åŠ åˆ° REQUIRED_REVIEWERS æ•°ç»„
              for reviewer in $(echo $REVIEWERS | tr ',' '\n'); do
                # å¦‚æœå®¡æ ¸è€…éç©ºï¼Œæ·»åŠ åˆ°æ•°ç»„
                if [ -n "$reviewer" ]; then
                  REQUIRED_REVIEWERS+=("$reviewer")
                fi
              done
            fi
          done

          # ä½¿ç”¨ bash æ•°ç»„å»é‡
          UNIQUE_REVIEWERS=($(echo "${REQUIRED_REVIEWERS[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

          # æ ¼å¼åŒ–å®¡æ ¸è€…åˆ—è¡¨ï¼Œå»é™¤å¤šä½™çš„ç©ºæ ¼
          REVIEWERS_LIST=$(echo "${UNIQUE_REVIEWERS[@]}" | tr -s '[:space:]' ' ' | sed 's/^ //;s/ $//')

          echo "REVIEWERS_LIST=$REVIEWERS_LIST" >> $GITHUB_ENV

      - name: Add comment and mention reviewers
        run: |
          REVIEWERS="${{ env.REVIEWERS_LIST }}"

          if [ -z "$REVIEWERS" ]; then
            echo "No reviewers to mention."
          else
            # æ„å»ºè¯„è®ºå†…å®¹
            COMMENT_BODY=$(jq -n --arg reviewers "$REVIEWERS" --arg labels "${{ env.LABELS }}" \
              '{"body": "Hey \($reviewers), could you please review this PR? ğŸ˜Š\n\nThe following labels were applied:\n- \($labels)\n\nPlease check the changes carefully, and let us know if you need any further details. Thank you for your time!"}')
            
            # æ·»åŠ è¯„è®º
            RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/response.json -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d "$COMMENT_BODY" \
              https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments)

            # æ£€æŸ¥ API è°ƒç”¨æ˜¯å¦æˆåŠŸ
            HTTP_STATUS=$(echo "$RESPONSE" | tail -n1)
            if [ "$HTTP_STATUS" -ne 201 ]; then
              echo "Error posting comment. Response: $RESPONSE"
              exit 1
            fi
          fi
